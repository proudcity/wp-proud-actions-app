!function($){function toggleMain(toggleClass,toggleType,select){switch(select=select||"",toggleType){case"remove":jQuery("#main-311"+select).removeClass(toggleClass);break;case"add":jQuery("#main-311"+select).addClass(toggleClass);break;default:jQuery("#main-311"+select).toggleClass(toggleClass)}}angular.module("scrollTo",[]).run(["$rootScope",function($rootScope){var currentYPosition=function(){return window.pageYOffset?window.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0};$rootScope.currentYPosition=currentYPosition,$rootScope.scrollTo=function(eID,scrollDiv,quick){function elmYPosition(eID){if(eID){for(var elm=document.getElementById(eID),y=elm.offsetTop,node=elm;node.offsetParent&&node.offsetParent!=document.body;)node=node.offsetParent,y+=node.offsetTop;return y}}var i,startY=currentYPosition(),stopY=elmYPosition(eID),distance=stopY>startY?stopY-startY:startY-stopY;if(100>distance||quick)return void scrollTo(0,stopY);var speed=Math.round(distance/100);speed>=20&&(speed=20);var step=Math.round(distance/25),leapY=stopY>startY?startY+step:startY-step,timer=0;if(stopY>startY)for(i=startY;stopY>i;i+=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY+=step,leapY>stopY&&(leapY=stopY),timer++;else for(i=startY;i>stopY;i-=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY-=step,stopY>leapY&&(leapY=stopY),timer++}}]),angular.module("311AppParent",["311App","angular-inview","angular-lazycompile"]).run(["$rootScope","$state","$stateParams","$window","$location",function($rootScope,$state,$stateParams,$window,$location){$rootScope.$state=$state,$rootScope.$stateParams=$stateParams,$rootScope.currentSection="",$rootScope.currentRoute="",$rootScope.mapboxAccessToken="pk.eyJ1IjoiYWxiYXRyb3NzZGlnaXRhbCIsImEiOiI1cVUxbUxVIn0.SqKOVeohLfY0vfShalVDUw",$rootScope.mapboxMap="albatrossdigital.lpkdpcjb",$rootScope.proudShowcaseKey="325jk154hl3y8r2J34NRAasdfasdf",$rootScope.showcaseApiUrl="http://ui.dev.getproudcity.com/",$rootScope.proudcityApi="http://my.getproudcity.com/api/proudcity/",$rootScope.proxyUrl=$rootScope.proudcityApi+"proxy",$rootScope.paymentUrl=$rootScope.proudcityApi+"invoice-example",$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){console.log("sjsjs")}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){$window.ga&&$window.ga("send","pageview",{page:$location.path(),title:toState.data&&toState.data.title?toState.data.title:"FILLME!"}),fromState.name&&fromState.name.length&&(!toState.data||!toState.data||!toState.data.skipScroll)}),$rootScope.goSubRoute=function(baseRoute,subRoute,baseName){baseName=void 0==baseName?"base":baseName;var stateName=baseRoute+"."+subRoute;try{var state=$state.get(stateName);if(void 0==state||null==state)throw"myException"}catch(e){stateName=baseRoute+"."+baseName}$state.go(stateName)}}]).directive("parent",function($state,Menu311,$location){return{restrict:"C",link:function($scope,$element,$attrs){$location.$$path||$location.path(Menu311.default311Url)}}}),angular.module("311AppParent").config(["$stateProvider","$urlRouterProvider","Menu311Provider",function($stateProvider,$urlRouterProvider,Menu311Provider){$stateProvider.state("city",{url:"/city","abstract":!0,templateUrl:"views/apps/311App/app-311-wrap.html"})}]),angular.module("drupalService",["ngResource"]).factory("Node",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.apiUrl+"/node/:nid.json",{nid:"@nid"},{get:{method:"GET",transformRequest:function(data,headersGetter){headersGetter().Accept="application/json"},cache:!1},query:{method:"GET",transformRequest:function(data,headersGetter){headersGetter().Accept="application/json"},cache:!1,isArray:!1}})}]).factory("View",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.apiUrl+"/rest/:entity/:bundle/:a/:b/:c",{entityType:"@entity",name:"@bundle",a:"@arg0"},{query:{method:"GET",cache:!0,isArray:!0}})}]).factory("TaxonomyTerm",["$resource","$rootScope",function($resource,$rootScope){var params={vocabulary:"@vocabulary"};return $rootScope.categorySection&&(params.field_faq_section=$rootScope.categorySection),$resource($rootScope.apiUrl+"/taxonomy_term/:tid.json",params,{get:{method:"GET",transformRequest:function(data,headersGetter){headersGetter().Accept="application/json"},cache:!0,isArray:!1},query:{method:"GET",transformRequest:function(data,headersGetter){headersGetter().Accept="application/json"},cache:!0,isArray:!1}})}]).factory("TaxonomyTermIndex",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.apiUrl+"taxonomy_term?vocabulary&sort=weight&direction=ASC",{vocabulary:"@vocabulary"},{query:{method:"GET",transformRequest:function(data,headersGetter){headersGetter().Accept="application/json"},cache:!0,isArray:!1}})}]).factory("TaxonomyTermNodes",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.apiUrl+"/taxonomy_term_nodes",{tid:"@tid"},{})}]).factory("User",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.apiUrl+"/user/:uid",{uid:"@uid"},{})}]).factory("Comment",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.apiUrl+"/node/:nid/comments",{nid:"@nid"},{post:{method:"POST",url:"/entity/comment"}})}]).factory("viewsFactory",["View",function(View){var service={};return service.pageLoad=function($scope,params){if(!$scope.loadingPage&&void 0!=$scope.items&&$scope.items.length>0){$scope.currentPage++;var newData=View.query(params,function(){newData.length>0&&(Array.prototype.push.apply($scope.items,newData),$scope.loadingPage=!1)})}$scope.loadingPage=!0},service}]).directive("openReveal",function(){return{restrict:"A",scope:{openReveal:"@"},link:function($scope,$element,$attrs){$element.on("click",function(){jQuery("#"+$scope.openReveal).foundation("reveal","open")})}}}),angular.module("311AppParent").filter("termByTid",function(){return function(items,tid){for(var i=0;i<items.length;i++)if(parseInt(items[i].tid)==parseInt(tid))return items[i];return null}}).filter("termsNoParent",function(){return function(items){for(var filtered=[],i=0;i<items.length;i++)0==items[i].parent.length&&filtered.push(items[i]);return filtered}}).filter("termsByParent",function(){return function(items,tid){for(var filtered=[],i=0;i<items.length;i++)for(var j=0;j<items[i].parent.length;j++)items[i].parent[j].id==tid&&filtered.push(items[i]);return filtered}}),angular.module("311App",["drupalService","seeClickFixService","paymentService","ui.router","ngSanitize","ngAnimate","stripe.checkout","ngTouch","scrollTo"]).run(["$rootScope","$state","$stateParams","$window","$location",function($rootScope,$state,$stateParams,$window,$location){var drupal="undefined"!=typeof Drupal?Drupal:{};$rootScope.apiUrl=_.get(drupal,"settings.proud_311_app.api_path")||"http://dev.getproudcity.com/",$rootScope.paymentUrl=_.get(drupal,"settings.proud_311_app.payment_url")||"http://demo.helmcivic.com/invoice-example",$rootScope.trackUrl=_.get(drupal,"settings.proud_311_app.track_url")||"http://markaspot.helmcivic.com/georeport/v2",$rootScope.seeclickfixUrl=_.get(drupal,"settings.proud_311_app.seeclickfixUrl")||"https://test.seeclickfix.com/api/v2/",$rootScope.vocabularyVid=5,$rootScope.appPageDisplay=_.get(drupal,"settings.proud_311_app.expand_section")||!1,$rootScope.categorySection=_.get(drupal,"settings.proud_311_app.category_section")||!1,$rootScope.displayExpanded=function(section){return section==$rootScope.appPageDisplay}}]).config(["$locationProvider","$stateProvider","$urlRouterProvider","StripeCheckoutProvider",function($locationProvider,$stateProvider,$urlRouterProvider,StripeCheckoutProvider){StripeCheckoutProvider.defaults({key:"pk_2Z9o15fO6InYzHSWk9GDeRmbuCWQ9"})}]),angular.module("311App").directive("menu",function($rootScope,Menu311,$state){return{restrict:"A",templateUrl:"views/apps/311App/menu311.html",link:function($scope,$element,$attrs){$scope.menu=Menu311.menu}}}).directive("mainToggle",function($window,$rootScope){return{restrict:"A",scope:{mainToggle:"@",mainToggleNest:"@",mainToggleForce:"@",mainToggleEnter:"@"},link:function($scope,$element,$attrs){var select=$scope.mainToggleNest?"-"+$scope.mainToggleNest:"";$scope.mainToggleEnter?toggleMain($scope.mainToggle,$scope.mainToggleForce,select):$element.on("click",function(){console.log($rootScope.currentYPosition()),$rootScope.currentYPosition()<300&&$("html, body").animate({scrollTop:$("#wrapper-311").offset().top-70},300),toggleMain($scope.mainToggle,$scope.mainToggleForce,select)})}}}).directive("menuClick",function($window,$browser){return{restrict:"A",link:function($scope,$element,$attrs){$element.on("click",function(event){return jQuery(".app-wrap").toggleClass("show-nav"),$attrs.menuClick&&"return-false"==$attrs.menuClick?(event.stopPropagation(),!1):void 0})}}}),angular.module("311App").provider("Menu311",function(){var drupal="undefined"!=typeof Drupal?Drupal:{},self=this,active311Items=_.get(drupal,"settings.proud_311_app.active_tabs")||{faq:!0,payments:!0,report:!0,status:!0};self.menu=[],_.forEach(active311Items,function(item,key){switch(key){case"faq":item&&(self.menu.push({title:"Get Answers",state:"faq",icon:"fa-question-circle"}),self.default311Url||(self.default311Url="/city/answers"));break;case"payments":item&&(self.menu.push({title:"Make a Payment",state:"payments",icon:"fa-credit-card"}),self.default311Url||(self.default311Url="/city/payments"));break;case"report":item&&(self.menu.push({title:"Report an Issue",state:"report",icon:"fa-exclamation-triangle"}),self.default311Url||(self.default311Url="/city/report"));break;case"status":item&&(self.menu.push({title:"Check Status",state:"status",icon:"fa-wrench"}),self.default311Url||(self.default311Url="/city/status"))}}),self.$get=function(){return self}}),angular.module("seeClickFixService",["ngResource"]).factory("TrackService",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.seeclickfixUrl+"issues/new?address",{address:"@address"},{query:{isArray:!1}})}]).factory("TrackFields",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.seeclickfixUrl+"request_types/:type",{type:"@type"})}]).factory("TrackIssue",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.seeclickfixUrl+"issues/:code",{code:"@code"},{get:{isArray:!1},save:{headers:{Authorization:"Basic jeff@albatrossdigital.com:test123"}}})}]),angular.module("trackService",["ngResource"]).factory("TrackService",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.trackUrl+"/services.json")}]).factory("Track",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.trackUrl+"/requests/:code.json",{code:"@code"},{get:{isArray:!0}})}]),angular.module("paymentService",["ngResource"]).factory("Payment",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.paymentUrl+"?number",{number:"@number"},{get:{cache:!0}})}]),angular.module("311App").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("city.faq",{url:"/answers",templateUrl:"views/apps/311App/faq/faq.html",data:{title:"FAQ",description:"About the about",keywords:"About, this, page",doScroll:!1},resolve:{terms:function($stateParams,$rootScope,TaxonomyTerm){return TaxonomyTerm.query({vocabulary:$rootScope.vocabularyVid,sort:"weight",direction:"ASC"}).$promise.then(function(data){return data.list})}},controller:function($scope,$rootScope,$state,terms){$scope.terms=terms,$scope.active=null,$scope.childOpen=!1,$scope.open=function(item){$scope.active=item},$scope.openChildren=function(){$scope.childOpen=!0}}}).state("city.faq.child",{url:"/:tid",templateUrl:"views/apps/311App/faq/faq-child.html",data:{title:"FAQ",description:"About the about",keywords:"About, this, page"},controller:function($scope,$rootScope,$state,$filter,terms,Node){$scope.activeTerm=$filter("termByTid")(terms,$state.params.tid),$scope.activeParent=$filter("termByTid")(terms,$scope.activeTerm.parent[0].id),$state.go("city.faq.child.answers",{nid:"list"})}}).state("city.faq.child.answers",{url:"/:nid",templateUrl:"views/apps/311App/faq/faq-child-answers.html",data:{title:"FAQ",description:"About the about",keywords:"About, this, page"},controller:function($scope,$rootScope,$state,$filter,Node){$scope.activeNid="list"!=$state.params.nid?$state.params.nid:null,Node.query({field_faq_category:$state.params.tid,sort:"title",direction:"ASC"}).$promise.then(function(data){$scope.nodes=data.list})}})}]),angular.module("311App").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("city.status",{url:"/status",data:{doScroll:!1},templateUrl:"views/apps/311App/issues/issue-status.html",controller:function($scope,$rootScope,$state){}}).state("city.status.item",{url:"/:code",templateUrl:"views/apps/311App/issues/issue-status-result.html",controller:function($scope,$rootScope,$state,TrackIssue){$scope.code=$state.params.code,TrackIssue.get({code:$state.params.code}).$promise.then(function(data){void 0!=data?$scope.item=data:$scope.error=!0,console.log($scope.item)})}}).state("city.report",{url:"/report",data:{doScroll:!1},templateUrl:"views/apps/311App/issues/issue-create-categories.html",resolve:{services:function($stateParams,TrackService,$rootScope){return void 0==$stateParams.city&&($stateParams={city:"Huntsville",state:"AL"}),console.log($stateParams.city+", "+$stateParams.state),TrackService.query({address:$stateParams.city+", "+$stateParams.state}).$promise.then(function(data){return void 0!=data.request_types?data.request_types:null})}},controller:function($scope,$rootScope,$state,services){for(var mapping=[{term:"animal",icon:"paw"},{term:"building",icon:"building"},{term:"cemetary",icon:void 0},{term:"weed",icon:"pagelines"},{term:"graffiti",icon:"paint-brush"},{term:"sidewalk",icon:"road"},{term:"light",icon:"lightbulb-o"},{term:"sign",icon:"map-signs"},{term:"tree",icon:"tree"},{term:"street",icon:"road"},{term:"garbage",icon:"trash-o"},{term:"sewer",icon:void 0},{term:"pothole",icon:"car"},{term:"parking",icon:"car"},{term:"car",icon:"car"},{term:"park",icon:"leaf"},{term:"litter",icon:"trash-o"},{term:"recycl",icon:"recycle"}],colors=["#BC2D07","#14A88E","#A4506C","#094558","#F68D38","#67412C"],i=0;i<services.length;i++){services[i].field_icon={color:colors[Math.floor(Math.random()*colors.length)]};for(var title=services[i].title.toLowerCase(),j=0;j<mapping.length;j++)-1!=title.indexOf(mapping[j].term)&&(services[i].field_icon.icon=mapping[j].icon);services[i].field_icon.icon=void 0==services[i].field_icon.icon?"file-text-o":services[i].field_icon.icon}console.log(services),$scope.types=services,$scope.typeUrl=function(url){var type=url.replace($rootScope.seeclickfixUrl+"request_types/","");return"city.report.map({type:'"+type+"'})"}}}).state("city.report.map",{url:"/:type",templateUrl:"views/apps/311App/issues/issue-create-map.html",controller:function($scope,$rootScope,$state,$http){$scope.type=$state.params.type,$scope.config=void 0,$http.get("//workhorse.albatrossdigital.com/proudcity-api.php?state="+$state.params.state+"&city="+$state.params.city).success(function(data){$scope.config=data}),$scope.next=function(){if(console.log(),void 0==$scope.marker)alert("Please enter an address, or click the Locate button to use your current location.");else{var latlng=$scope.marker.getLatLng();$state.go("city.report.map.details",{lat:latlng.lat,lng:latlng.lng})}},$scope.$watch("config",function(value){if(void 0!=$scope.config){L.mapbox.accessToken=$rootScope.mapboxAccessToken;var map=new L.mapbox.Map("issue-map",$rootScope.mapboxMap,{center:new L.LatLng($scope.config.lat,$scope.config.lng),zoom:15,scrollWheelZoom:!1});$scope.marker=null;var addMarker=function(self){var latlng=void 0!=self.latlng?self.latlng:new L.LatLng(self.feature.center[1],self.feature.center[0]);$scope.marker=L.marker(latlng,{icon:L.mapbox.marker.icon({"marker-color":"ff8888"}),draggable:!0}).addTo(map),$scope.$apply()};map.on("click",function(self){null===$scope.marker&&addMarker(self)}),map.addControl(L.mapbox.geocoderControl("mapbox.places",{keepOpen:!0,autocomplete:!0}).on("select",addMarker).on("autoselect",addMarker)),L.control.locate({drawCircle:!0}).addTo(map),map.on("locationfound",addMarker)}})}}).state("city.report.map.details",{url:"/details?lat&lng",templateUrl:"views/apps/311App/issues/issue-create-details.html",resolve:{data:function($stateParams,$rootScope,TrackFields){return TrackFields.get({type:$stateParams.type}).$promise.then(function(data){return console.log(data),{categoryTitle:data.title,fields:data.questions}})}},controller:function($scope,$rootScope,$state,data,$http){$scope.type=$state.params.type,$scope.form={request_type_id:$scope.type,lat:$state.params.lat,lng:$state.params.lng,answers:{}},$scope.fields=data.fields,$scope.form.category=data.categoryTitle,$scope.submit=function(data){console.log(JSON.stringify(data)),$http.post($rootScope.seeclickfixUrl+"issues",data).then(function(response){console.log(response)},function(response){})}}})}]),angular.module("311App").config(["$stateProvider","$urlRouterProvider","StripeCheckoutProvider",function($stateProvider,$urlRouterProvider,StripeCheckoutProvider){$stateProvider.state("city.payments",{templateUrl:"views/apps/311App/payment/payment.html",data:{doScroll:!1},url:"/payments",resolve:{nodes:function($stateParams,Node){return Node.query({type:"payment"}).$promise.then(function(data){return data.list})}},controller:function($scope,$rootScope,$state,nodes){$scope.nodes=nodes}}).state("city.payments.type",{templateUrl:"views/apps/311App/payment/payment-type.html",url:"/:nid",resolve:{node:function($stateParams,$filter,nodes){return $filter("filter")(nodes,{nid:$stateParams.nid})[0]},stripe:StripeCheckoutProvider.load},controller:function($scope,$rootScope,$state,node,Payment,StripeCheckout){$scope.node=node,$scope.demoInfo=!1,$scope.payment={number:"",amount:""},$scope.numberClass="",$scope.demoInfoToggle=function(e){$scope.demoInfo=!$scope.demoInfo,console.log($scope.demoInfo),e.preventDefault()},$scope.$watch("payment.number",function(){""!=$scope.payment.number&&$scope.payment.number.length>3?($scope.numberClass="has-warning",Payment.get({city:void 0!=$scope.location?$scope.location.city:null,state:void 0!=$scope.location?$scope.location.state:null,number:$scope.payment.number},function(data){void 0!=data.amount?($scope.payment.amount=data.amount,$scope.payment.name=data.name,$scope.numberClass="has-success"):($scope.payment.amount="",$scope.numberClass="has-error")})):$scope.numberClass=""});var handler=StripeCheckout.configure({name:node.title,token:function(token,args){}});$scope.submit=function(payment){if(void 0!=$scope.node.field_payment_link)window.location=$scope.node.field_payment_link.replace("[invoice]",payment.number).replace("[amount]",payment.amount);else{var options={description:"Invice "+payment.number,amount:100*$scope.amount};handler.open(options).then(function(result){},function(){})}}}}).state("city.payments.success",{templateUrl:"views/apps/311App/payment/payment-success.html",url:"/:nid/:token",resolve:{node:function($stateParams,$filter,nodes){return $filter("filter")(nodes,{nid:$stateParams.nid})[0]}},controller:function($scope,$rootScope,$state,node,Payment){}})}])}(jQuery);