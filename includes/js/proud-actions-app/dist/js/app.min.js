!function($){function toggleMain(toggleClass,toggleType,select){switch(select=select||"",toggleType){case"remove":jQuery("#main-311"+select).removeClass(toggleClass);break;case"add":jQuery("#main-311"+select).addClass(toggleClass);break;default:jQuery("#main-311"+select).toggleClass(toggleClass)}}angular.module("scrollTo",[]).run(["$rootScope",function($rootScope){/* currentYPosition -
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
var currentYPosition=function(){
// Firefox, Chrome, Opera, Safari
// Firefox, Chrome, Opera, Safari
// Internet Explorer 6 - standards mode
// Internet Explorer 6, 7 and 8
return window.pageYOffset?window.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0};$rootScope.currentYPosition=currentYPosition,/* scrollTo -
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
$rootScope.scrollTo=function(eID,scrollDiv,quick){/* scrollTo -
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
function elmYPosition(eID){if(eID){for(var elm=document.getElementById(eID),y=elm.offsetTop,node=elm;node.offsetParent&&node.offsetParent!=document.body;)node=node.offsetParent,y+=node.offsetTop;return y}}
// This scrolling function 
// is from http://www.itnewb.com/tutorial/Creating-the-Smooth-Scroll-Effect-with-JavaScript
var i,startY=currentYPosition(),stopY=elmYPosition(eID),distance=stopY>startY?stopY-startY:startY-stopY;if(100>distance||quick)return void scrollTo(0,stopY);var speed=Math.round(distance/100);speed>=20&&(speed=20);var step=Math.round(distance/25),leapY=stopY>startY?startY+step:startY-step,timer=0;if(stopY>startY)for(i=startY;stopY>i;i+=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY+=step,leapY>stopY&&(leapY=stopY),timer++;else for(i=startY;i>stopY;i-=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY-=step,stopY>leapY&&(leapY=stopY),timer++}}]),
//***************************************
// Main Application
//***************************************
angular.module("311AppParent",["311App","angular-inview","angular-lazycompile"]).run(["$rootScope","$state","$stateParams","$window","$location",function($rootScope,$state,$stateParams,$window,$location){
// It's very handy to add references to $state and $stateParams to the $rootScope
$rootScope.$state=$state,$rootScope.$stateParams=$stateParams,$rootScope.currentSection="",$rootScope.currentRoute="",$rootScope.mapboxAccessToken=_.get(Proud,"settings.proud_actions_app.mapbox_access_token")||"pk.eyJ1IjoiYWxiYXRyb3NzZGlnaXRhbCIsImEiOiI1cVUxbUxVIn0.SqKOVeohLfY0vfShalVDUw",$rootScope.mapboxMap=_.get(Proud,"settings.proud_actions_app.mapbox_map")||"albatrossdigital.lpkdpcjb",$rootScope.proudShowcaseKey="325jk154hl3y8r2J34NRAasdfasdf",$rootScope.showcaseApiUrl="http://ui.dev.getproudcity.com/",//@todo: switch to my.getproudcity.com
// $rootScope.proudcityApi='http://localhost:32790/api/proudcity/';
$rootScope.proudcityApi="http://my.getproudcity.com/api/proudcity/",
//$rootScope.proudcityApi='http://localhost:32804/api/proudcity/';
$rootScope.proxyUrl=$rootScope.proudcityApi+"proxy",$rootScope.paymentUrl=$rootScope.proudcityApi+"invoice-example",
// Apply meta data if available
$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){
// send tracking
$window.ga&&$window.ga("send","pageview",{page:$location.path(),title:toState.data&&toState.data.title?toState.data.title:"FILLME!"}),fromState.name&&fromState.name.length&&(!toState.data||!toState.data||!toState.data.skipScroll)}),
// Helper function detects the correct sub route to go to (for templating)
$rootScope.goSubRoute=function(baseRoute,subRoute,baseName){baseName=void 0==baseName?"base":baseName;var stateName=baseRoute+"."+subRoute;try{var state=$state.get(stateName);if(void 0==state||null==state)throw"myException"}catch(e){stateName=baseRoute+"."+baseName}$state.go(stateName)}}]).directive("parent",function($rootScope,Menu311,$location){return{restrict:"C",link:function($scope,$element,$attrs){$location.$$path||$location.path(Menu311.getDefaultUrl($rootScope.appId))}}}),
//angular.module('app.faq', [
//  'ui.router' 
//])
angular.module("311AppParent").config(["$stateProvider","$urlRouterProvider","Menu311Provider",function($stateProvider,$urlRouterProvider,Menu311Provider){
// Redirect if on city hompage
// $urlRouterProvider.when(/\//i, ['$match', '$stateParams', function ($match, $stateParams) {
//   return '/answers';
// }]);
// $urlRouterProvider.otherwise(Menu311Provider.default311Url);
$stateProvider.state("city",{url:"/city","abstract":!0,template:"<div app-311-wrap></div>"})}]),angular.module("wordpressService",["ngResource"]).factory("Post",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.apiUrl+":postType/:id",{id:"@nid",postType:"@postType"},{get:{method:"GET",transformRequest:function(data,headersGetter){headersGetter().Accept="application/json"},cache:!1},query:{method:"GET",transformRequest:function(data,headersGetter){headersGetter().Accept="application/json"},cache:!1,isArray:!0}})}]).factory("TaxonomyTerm",["$resource","$rootScope",function($resource,$rootScope){var params={vocabulary:"@vocabulary",per_page:1e3};return $rootScope.categorySection&&(params.field_faq_section=$rootScope.categorySection),$resource($rootScope.apiUrl+"terms/:vocabulary/:tid",params,{get:{method:"GET",transformRequest:function(data,headersGetter){headersGetter().Accept="application/json"},cache:!0,isArray:!1},query:{method:"GET",transformRequest:function(data,headersGetter){headersGetter().Accept="application/json"},cache:!0,isArray:!0}})}]).factory("TaxonomyTermPosts",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.apiUrl+"/taxonomy_term_nodes",{tid:"@tid"},{})}]).factory("User",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.apiUrl+"/user/:uid",{uid:"@uid"},{})}]).factory("Comment",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.apiUrl+"/node/:nid/comments",{nid:"@nid"},{post:{method:"POST",url:"/entity/comment"}})}]).factory("viewsFactory",["View",function(View){var service={};
// For infinite scroll pager
return service.pageLoad=function($scope,params){if(!$scope.loadingPage&&void 0!=$scope.items&&$scope.items.length>0){$scope.currentPage++;var newData=View.query(params,function(){newData.length>0&&(Array.prototype.push.apply($scope.items,newData),$scope.loadingPage=!1)})}$scope.loadingPage=!0},service}]).directive("openReveal",function(){return{restrict:"A",scope:{openReveal:"@"},link:function($scope,$element,$attrs){
// listen for a click
$element.on("click",function(){jQuery("#"+$scope.openReveal).foundation("reveal","open")})}}}),angular.module("311AppParent").filter("termById",function(){return function(items,id){for(var i=0;i<items.length;i++)if(parseInt(items[i].id)==parseInt(id))return items[i];return null}}).filter("termBySlug",function(){return function(items,slug){for(var i=0;i<items.length;i++)if(items[i].slug===slug)return items[i];return null}}).filter("termsNoParent",function(){return function(items,categories){for(var filtered=[],i=0;i<items.length;i++)0==items[i].parent&&(categories?categories.indexOf(items[i].slug)>=0&&filtered.push(items[i]):filtered.push(items[i]));return filtered}}).filter("termsByParent",function(){return function(items,id){for(var filtered=[],i=0;i<items.length;i++)items[i].parent==id&&filtered.push(items[i]);return filtered}}),angular.module("311App",["wordpressService","seeClickFixService","paymentService","ui.router","ngSanitize","ngAnimate","stripe.checkout","ngTouch","scrollTo"]).run(["$rootScope","$state","$stateParams","$window","$location",function($rootScope,$state,$stateParams,$window,$location){
// Api Options
// ---------------------------
$rootScope.apiUrl=_.get(Proud,"settings.proud_actions_app.global.api_path")||"http://wordpress.albatrossdemos.com/wp-json/wp/v2/",$rootScope.paymentUrl=_.get(Proud,"settings.proud_actions_app.global.payment_url")||"http://demo.helmcivic.com/invoice-example",//$rootScope.proudcityApi + 'invoice-example';
$rootScope.trackUrl=_.get(Proud,"settings.proud_actions_app.global.track_url")||"http://markaspot.helmcivic.com/georeport/v2",$rootScope.seeclickfixUrl=_.get(Proud,"settings.proud_actions_app.global.seeclickfixUrl")||"https://test.seeclickfix.com/api/v2/",
// Global options
// ---------------------------
$rootScope.activeCity=_.get(Proud,"settings.global.location.city")||"Huntsville",$rootScope.activeState=_.get(Proud,"settings.global.location.state")||"Alabama",
// Helper function returns boolean for if we're in "full page mode"
$rootScope.displayExpanded=function(section){return section==$rootScope.appPageDisplay}}]).config(["$locationProvider","$stateProvider","$urlRouterProvider","StripeCheckoutProvider",function($locationProvider,$stateProvider,$urlRouterProvider,StripeCheckoutProvider){
// set location provider as regular urls
// $locationProvider.html5Mode(true);
StripeCheckoutProvider.defaults({key:_.get(Proud,"settings.proud_actions_app.global.payment_key")||""})}]).directive("app311Wrap",function($window,$rootScope){return{restrict:"AC",templateUrl:"views/apps/311App/app-311-wrap.html",transclude:!0,link:function($scope,$element,$attrs){
// Display options
// ---------------------------
// Expand categories?
$rootScope.appPageDisplay=_.get(Proud,"settings.proud_actions_app.instances."+$rootScope.appId+".expand_section")||!1;
// Restrict to visitor, resident, ect ?
var categories=_.get(Proud,"settings.proud_actions_app.instances."+$rootScope.appId+".category_section")||!1;categories=_.transform(_.values(categories),function(res,v,k){v&&"0"!==v&&res.push(v)}),$rootScope.categories=categories}}}),angular.module("311App").directive("menu",function($rootScope,Menu311,$state){return{restrict:"A",templateUrl:"views/apps/311App/menu311.html",link:function($scope,$element,$attrs){
// Push to scope
$scope.menu=Menu311.getMenu($rootScope.appId)}}}).directive("mainToggle",function($window,$rootScope){return{restrict:"A",scope:{mainToggle:"@",mainToggleNest:"@",mainToggleForce:"@",mainToggleEnter:"@"},link:function($scope,$element,$attrs){var select=$scope.mainToggleNest?"-"+$scope.mainToggleNest:"";
// Are we a link?
$scope.mainToggleEnter?toggleMain($scope.mainToggle,$scope.mainToggleForce,select):
// listen for a click
$element.on("click",function(){console.log($rootScope.currentYPosition()),
// Animate down if necessary
$rootScope.currentYPosition()<300&&$("html, body").animate({scrollTop:$("#wrapper-311").offset().top-70},300),toggleMain($scope.mainToggle,$scope.mainToggleForce,select)})}}}).directive("menuClick",function($window,$browser){return{restrict:"A",link:function($scope,$element,$attrs){$element.on("click",function(event){return jQuery(".app-wrap").toggleClass("show-nav"),$attrs.menuClick&&"return-false"==$attrs.menuClick?(event.stopPropagation(),!1):void 0})}}}),angular.module("311App").provider("Menu311",function(){
// Init Proud   
var self=this,active311Items=null,default311Url=null,menu=[],initMenu=function(appId){
// Only run once
active311Items||(active311Items=_.get(Proud,"settings.proud_actions_app.instances."+appId+".active_tabs")||{faq:!0,payments:!0,report:0,status:0},_.forEach(active311Items,function(item,key){switch(key){case"faq":item&&"0"!==item&&(menu.push({title:"Get Answers",state:"faq",icon:"fa-question-circle"}),default311Url||(default311Url="/city/answers"));break;case"payments":item&&"0"!==item&&(menu.push({title:"Make a Payment",state:"payments",icon:"fa-credit-card"}),default311Url||(default311Url="/city/payments"));break;case"report":item&&"0"!==item&&(menu.push({title:"Report an Issue",state:"report",icon:"fa-exclamation-triangle"}),default311Url||(default311Url="/city/report"));break;case"status":item&&"0"!==item&&(menu.push({title:"Check Status",state:"status",icon:"fa-wrench"}),default311Url||(default311Url="/city/status"))}}))};self.getDefaultUrl=function(appId){return initMenu(appId),default311Url},self.getMenu=function(appId){return initMenu(appId),menu},
// Just return self
self.$get=function(){return self}}),angular.module("seeClickFixService",["ngResource"]).factory("TrackService",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.seeclickfixUrl+"issues/new?address",{address:"@address"},{query:{isArray:!1}})}]).factory("TrackFields",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.seeclickfixUrl+"request_types/:type",{type:"@type"})}]).factory("TrackIssue",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.seeclickfixUrl+"issues/:code",{code:"@code"},{get:{isArray:!1},save:{headers:{Authorization:"Basic jeff@albatrossdigital.com:test123"}}})}]),angular.module("trackService",["ngResource"]).factory("TrackService",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.trackUrl+"/services.json")}]).factory("Track",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.trackUrl+"/requests/:code.json",{code:"@code"},{get:{isArray:!0}})}]),angular.module("paymentService",["ngResource"]).factory("Payment",["$resource","$rootScope",function($resource,$rootScope){return $resource($rootScope.paymentUrl+"?number",{number:"@number"},{get:{cache:!0}})}]),angular.module("311App").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("city.faq",{url:"/answers",templateUrl:"views/apps/311App/faq/faq.html",data:{title:"FAQ",// Sets meta title
description:"About the about",// Sets different meta description
keywords:"About, this, page",// Sets different meta keywords,
doScroll:!1},resolve:{terms:function($stateParams,$rootScope,TaxonomyTerm){return TaxonomyTerm.query({vocabulary:"faq-topic",sort:"weight",direction:"ASC"}).$promise.then(function(data){return data})}},controller:function($scope,$rootScope,$state,terms){$scope.terms=terms,$scope.active=null,$scope.childOpen=!1,$scope.open=function(item){$scope.active=item},$scope.openChildren=function(){$scope.childOpen=!0}}}).state("city.faq.child",{url:"/:slug",templateUrl:"views/apps/311App/faq/faq-child.html",data:{title:"FAQ",// Sets meta title
description:"About the about",// Sets different meta description
keywords:"About, this, page"},controller:function($scope,$rootScope,$state,$filter,terms,Post){$scope.activeTerm=$filter("termBySlug")(terms,$state.params.slug),$scope.activeParent=$filter("termById")(terms,$scope.activeTerm.parent),$state.go("city.faq.child.answers",{nid:"list"})}}).state("city.faq.child.answers",{url:"/:postSlug",templateUrl:"views/apps/311App/faq/faq-child-answers.html",data:{title:"FAQ",// Sets meta title
description:"About the about",// Sets different meta description
keywords:"About, this, page"},controller:function($scope,$rootScope,$state,$filter,Post){$scope.activeSlug="list"!=$state.params.postSlug?$state.params.postSlug:null,
// @todo: put this in resolve
Post.query({postType:"questions","filter[faq-topic]":$state.params.slug,sort:"title",direction:"ASC"}).$promise.then(function(data){$scope.nodes=data})}})}]),angular.module("311App").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){
//.when('', '/answers');
$stateProvider.state("city.status",{url:"/status",data:{doScroll:!1},templateUrl:"views/apps/311App/issues/issue-status.html",controller:function($scope,$rootScope,$state){}}).state("city.status.item",{url:"/:code",templateUrl:"views/apps/311App/issues/issue-status-result.html",controller:function($scope,$rootScope,$state,TrackIssue){$scope.code=$state.params.code,TrackIssue.get({code:$state.params.code}).$promise.then(function(data){void 0!=data?$scope.item=data:$scope.error=!0,console.log($scope.item)})}}).state("city.report",{url:"/report",data:{doScroll:!1},templateUrl:"views/apps/311App/issues/issue-create-categories.html",resolve:{services:function($stateParams,TrackService,$rootScope){return TrackService.query({address:$rootScope.activeCity+", "+$rootScope.activeState}).$promise.then(function(data){return void 0!=data.request_types?data.request_types:null})}},controller:function($scope,$rootScope,$state,services){for(var mapping=[{term:"animal",icon:"paw"},{term:"building",icon:"building"},{term:"cemetary",icon:void 0},{term:"weed",icon:"pagelines"},{term:"graffiti",icon:"paint-brush"},{term:"sidewalk",icon:"road"},{term:"light",icon:"lightbulb-o"},{term:"sign",icon:"map-signs"},// @todo: added in fa 4.4
{term:"tree",icon:"tree"},{term:"street",icon:"road"},{term:"garbage",icon:"trash-o"},{term:"sewer",icon:void 0},{term:"pothole",icon:"car"},{term:"parking",icon:"car"},{term:"car",icon:"car"},{term:"park",icon:"leaf"},{term:"litter",icon:"trash-o"},{term:"recycl",icon:"recycle"}],colors=["#BC2D07","#14A88E","#A4506C","#094558","#F68D38","#67412C"],i=0;i<services.length;i++){services[i].field_icon={color:colors[Math.floor(Math.random()*colors.length)]};for(var title=services[i].title.toLowerCase(),j=0;j<mapping.length;j++)-1!=title.indexOf(mapping[j].term)&&(services[i].field_icon.icon=mapping[j].icon);services[i].field_icon.icon=void 0==services[i].field_icon.icon?"file-text-o":services[i].field_icon.icon}console.log(services),$scope.types=services,$scope.typeUrl=function(url){var type=url.replace($rootScope.seeclickfixUrl+"request_types/","");return"city.report.map({type:'"+type+"'})"}}}).state("city.report.map",{url:"/:type",templateUrl:"views/apps/311App/issues/issue-create-map.html",controller:function($scope,$rootScope,$state,$http){$scope.type=$state.params.type,$scope.config=void 0,$http.get("//workhorse.albatrossdigital.com/proudcity-api.php?state="+$rootScope.activeState+"&city="+$rootScope.activeCity).success(function(data){$scope.config=data}),$scope.next=function(){if(console.log(),void 0==$scope.marker)alert("Please enter an address, or click the Locate button to use your current location.");else{var latlng=$scope.marker.getLatLng();$state.go("city.report.map.details",{lat:latlng.lat,lng:latlng.lng})}},$scope.$watch("config",function(value){if(void 0!=$scope.config){L.mapbox.accessToken=$rootScope.mapboxAccessToken;var map=new L.mapbox.Map("issue-map",$rootScope.mapboxMap,{center:new L.LatLng($scope.config.lat,$scope.config.lng),zoom:15,scrollWheelZoom:!1});$scope.marker=null;var addMarker=function(self){var latlng=void 0!=self.latlng?self.latlng:new L.LatLng(self.feature.center[1],self.feature.center[0]);$scope.marker=L.marker(latlng,{icon:L.mapbox.marker.icon({"marker-color":"ff8888"}),draggable:!0}).addTo(map),$scope.$apply()};
// Add marker when the map is clicked (if it hasn't already been added)
map.on("click",function(self){null===$scope.marker&&addMarker(self)}),
// Add geocode control, add marker when selected
map.addControl(L.mapbox.geocoderControl("mapbox.places",{keepOpen:!0,autocomplete:!0}).on("select",addMarker).on("autoselect",addMarker)),
// Add locate control, add marker when located
L.control.locate({drawCircle:!0}).addTo(map),map.on("locationfound",addMarker)}})}}).state("city.report.map.details",{url:"/details?lat&lng",templateUrl:"views/apps/311App/issues/issue-create-details.html",resolve:{data:function($stateParams,$rootScope,TrackFields){return TrackFields.get({type:$stateParams.type}).$promise.then(function(data){return console.log(data),{categoryTitle:data.title,fields:data.questions}})}},controller:function($scope,$rootScope,$state,data,$http){$scope.type=$state.params.type,$scope.form={request_type_id:$scope.type,lat:$state.params.lat,lng:$state.params.lng,answers:{}},$scope.fields=data.fields,$scope.form.category=data.categoryTitle,$scope.submit=function(data){/*var issue = new TrackIssue(data);
              issue.$save(function(data, putResponseHeaders) {
                console.log(data);
                //u => saved user object
                //putResponseHeaders => $http header getter
              });*/
console.log(JSON.stringify(data)),$http.post($rootScope.seeclickfixUrl+"issues",data).then(function(response){console.log(response)},function(response){})}}})}]),angular.module("311App").config(["$stateProvider","$urlRouterProvider","StripeCheckoutProvider",function($stateProvider,$urlRouterProvider,StripeCheckoutProvider){$stateProvider.state("city.payments",{templateUrl:"views/apps/311App/payment/payment.html",data:{doScroll:!1},url:"/payments",resolve:{posts:function($stateParams,Post){return Post.query({postType:"payments"}).$promise.then(function(data){return data})}},controller:function($scope,$rootScope,$state,posts){$scope.posts=posts}}).state("city.payments.type",{templateUrl:"views/apps/311App/payment/payment-type.html",url:"/:slug",resolve:{post:function($stateParams,$filter,posts){return $filter("filter")(posts,{slug:$stateParams.slug})[0]},stripe:StripeCheckoutProvider.load},controller:function($scope,$rootScope,$state,post,Payment,StripeCheckout){console.log(post),$scope.post=post,$scope.demoInfo=!1,$scope.payment={number:"",amount:""},$scope.numberClass="",$scope.demoInfoToggle=function(e){$scope.demoInfo=!$scope.demoInfo,console.log($scope.demoInfo),e.preventDefault()},
// Talk to invoice API
$scope.$watch("payment.number",function(){""!=$scope.payment.number&&$scope.payment.number.length>3?($scope.numberClass="has-warning",Payment.get({city:void 0!=$scope.location?$scope.location.city:null,state:void 0!=$scope.location?$scope.location.state:null,number:$scope.payment.number},function(data){void 0!=data.amount?($scope.payment.amount=data.amount,$scope.payment.name=data.name,$scope.numberClass="has-success"):($scope.payment.amount="",$scope.numberClass="has-error")})):$scope.numberClass=""});
// Initialize Stripe
var handler=StripeCheckout.configure({name:post.title,token:function(token,args){}});
// Submit
$scope.submit=function(payment){if(void 0!=$scope.post.field_payment_link)window.location=$scope.post.field_payment_link.replace("[invoice]",payment.number).replace("[amount]",payment.amount);else{
// Stripe checkout 
var options={description:"Invice "+payment.number,amount:100*$scope.amount};
// The rejection callback doesn't work in IE6-7.
handler.open(options).then(function(result){},function(){})}}}}).state("city.payments.success",{templateUrl:"views/apps/311App/payment/payment-success.html",url:"/:nid/:token",resolve:{post:function($stateParams,$filter,posts){return $filter("filter")(posts,{nid:$stateParams.nid})[0]}},controller:function($scope,$rootScope,$state,post,Payment){}})}])}(jQuery);